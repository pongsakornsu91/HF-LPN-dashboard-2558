<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lamphun HF Registry</title>

    <!-- CSS Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #F3F4F6;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        [v-cloak] {
            display: none;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-modal-content, .print-modal-content * {
                visibility: visible;
            }
            .print-modal-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background-color: white;
            }
            /* Hide non-printable elements */
            .no-print {
                display: none !important;
            }
            /* Adjust inputs for print */
            input, select, textarea {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                resize: none;
                -webkit-appearance: none;
                moz-appearance: none;
                appearance: none;
            }
            /* Expand textareas */
            textarea {
                height: auto;
            }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "rxjs": "https://aistudiocdn.com/rxjs@^7.8.2?conditions=es2015",
    "rxjs/operators": "https://aistudiocdn.com/rxjs@^7.8.2/operators?conditions=es2015",
    "rxjs/ajax": "https://aistudiocdn.com/rxjs@^7.8.2/ajax?conditions=es2015",
    "rxjs/webSocket": "https://aistudiocdn.com/rxjs@^7.8.2/webSocket?conditions=es2015",
    "rxjs/testing": "https://aistudiocdn.com/rxjs@^7.8.2/testing?conditions=es2015",
    "rxjs/fetch": "https://aistudiocdn.com/rxjs@^7.8.2/fetch?conditions=es2015",
    "@angular/core": "https://next.esm.sh/@angular/core@^21.0.3?external=rxjs",
    "@angular/common": "https://next.esm.sh/@angular/common@^21.0.3?external=rxjs",
    "@angular/forms": "https://next.esm.sh/@angular/forms@^21.0.3?external=rxjs"
  }
}
</script>
</head>
<body>
    <div id="app" v-cloak class="min-h-screen flex flex-col relative font-sans text-gray-900">
        
        <!-- Hidden File Input for JSON Backup Import -->
        <input type="file" ref="fileInput" class="hidden" accept=".json" @change="onFileSelected">
        <!-- Hidden File Input for CSV Import -->
        <input type="file" ref="csvInput" class="hidden" accept=".csv" @change="onCsvSelected">

        <!-- Navbar -->
        <nav class="bg-white shadow-sm border-b border-gray-200 z-20 no-print">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-4">
                        <img src="https://www.lpnh.go.th/70.svg" alt="Logo" class="h-10 w-auto">
                        <div class="flex flex-col">
                            <span class="text-xl font-bold text-gray-900">HF Registry</span>
                            <span class="text-xs text-gray-700 font-medium">เครือข่ายหัวใจล้มเหลว จ.ลำพูน</span>
                        </div>
                        <!-- Environment Status Indicator -->
                        <span v-if="isGasEnvironment" class="hidden md:flex text-[10px] font-bold bg-green-100 text-green-800 px-2 py-1 rounded border border-green-200 items-center gap-1 ml-2">
                            <i class="fa-solid fa-link"></i> Live Database
                        </span>
                        <span v-else class="hidden md:flex text-[10px] font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200 items-center gap-1 ml-2">
                            <i class="fa-solid fa-laptop-code"></i> Local Mock Mode
                        </span>
                    </div>
                    <div class="flex items-center gap-4">
                        <template v-if="isLoggedIn">
                            <!-- Admin Tools -->
                            <div v-if="userRole === 'admin'" class="flex gap-2 mr-4 border-r border-gray-300 pr-4">
                                <button @click="triggerCsvImport" class="text-gray-500 hover:text-green-700 text-xs font-bold flex flex-col items-center p-1 rounded">
                                    <i class="fa-solid fa-file-import text-base mb-0.5"></i> นำเข้า CSV
                                </button>
                                <button @click="backupDb" class="text-gray-500 hover:text-indigo-600 text-xs font-bold flex flex-col items-center p-1 rounded">
                                    <i class="fa-solid fa-download text-base mb-0.5"></i> สำรองข้อมูล
                                </button>
                                <button @click="triggerImport" class="text-gray-500 hover:text-red-600 text-xs font-bold flex flex-col items-center p-1 rounded">
                                    <i class="fa-solid fa-upload text-base mb-0.5"></i> กู้คืนข้อมูล
                                </button>
                            </div>

                            <div class="text-sm font-bold text-indigo-900 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">
                                <i class="fa-solid fa-user-doctor mr-2"></i>
                                {{ userRole === 'admin' ? 'Admin (IPD)' : 'เจ้าหน้าที่ OPD' }}
                            </div>
                            <button @click="logout" class="text-red-600 hover:text-red-800 text-sm font-bold px-3 py-1 hover:bg-red-50 rounded transition-colors">
                                <i class="fa-solid fa-right-from-bracket"></i> ออกจากระบบ
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Login Modal Overlay -->
        <div v-if="!isLoggedIn" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-80 backdrop-blur-sm flex items-center justify-center no-print">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform transition-all border border-gray-100">
                <div class="text-center mb-8">
                    <img src="https://www.lpnh.go.th/70.svg" class="mx-auto h-20 mb-4">
                    <h2 class="text-2xl font-extrabold text-gray-900">เข้าสู่ระบบ</h2>
                    <p class="text-gray-700 text-sm font-bold mt-2">ระบบทะเบียนผู้ป่วยหัวใจล้มเหลว</p>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-gray-900 mb-1.5">ชื่อผู้ใช้งาน</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-user text-gray-500"></i>
                            </div>
                            <input type="text" v-model="loginForm.username" class="pl-10 block w-full rounded-lg border-gray-300 bg-white text-gray-900 focus:ring-indigo-600 focus:border-indigo-600 py-3 font-bold shadow-sm" placeholder="Username">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-900 mb-1.5">รหัสผ่าน</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-lock text-gray-500"></i>
                            </div>
                            <input type="password" v-model="loginForm.password" class="pl-10 block w-full rounded-lg border-gray-300 bg-white text-gray-900 focus:ring-indigo-600 focus:border-indigo-600 py-3 font-bold shadow-sm" placeholder="••••••••">
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button @click="login('opd')"
                            class="flex-1 bg-white border border-indigo-200 text-indigo-700 hover:bg-indigo-50 py-3 rounded-lg font-extrabold transition-all shadow-sm hover:shadow">
                            OPD Login
                        </button>
                        <button @click="login('admin')"
                            class="flex-1 bg-indigo-600 text-white hover:bg-indigo-700 py-3 rounded-lg font-extrabold transition-all shadow-lg shadow-indigo-200">
                            Admin Login
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main v-if="isLoggedIn" class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 no-print">

            <!-- Tabs Header -->
            <div class="mb-8 border-b border-gray-200 bg-white rounded-t-xl px-4 shadow-sm">
                <nav class="-mb-px flex space-x-8">
                    <button @click="activeTab = 1"
                        :class="activeTab === 1 ? 'border-indigo-600 text-indigo-700' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-bold text-sm flex items-center gap-2 transition-colors">
                        <i class="fa-solid fa-users-viewfinder"></i>
                        ภาพรวมผู้ป่วย
                    </button>
                    <button @click="activeTab = 2"
                        :class="activeTab === 2 ? 'border-indigo-600 text-indigo-700' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-bold text-sm flex items-center gap-2 transition-colors">
                        <i class="fa-solid fa-bed-pulse"></i>
                        ติดตามผู้ป่วย IPD
                    </button>
                    <button @click="activeTab = 3"
                        :class="activeTab === 3 ? 'border-indigo-600 text-indigo-700' : 'border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-bold text-sm flex items-center gap-2 transition-colors">
                        <i class="fa-solid fa-calendar-check"></i>
                        คลินิก OPD
                    </button>
                </nav>
            </div>

            <!-- Tab 1: Overview -->
            <div v-if="activeTab === 1" class="space-y-6">
                <!-- Top Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div @click="filterTotal" class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:border-indigo-500 hover:shadow-md transition-all cursor-pointer group">
                        <p class="text-sm font-bold text-gray-600 uppercase tracking-wider group-hover:text-indigo-700">ผู้ป่วยทั้งหมด</p>
                        <p class="mt-2 text-4xl font-extrabold text-gray-900">{{ stats.total }}</p>
                        <p class="text-xs text-indigo-400 mt-1 font-medium group-hover:text-indigo-600">คลิกเพื่อดูรายชื่อทั้งหมด</p>
                    </div>
                    <div @click="setFilter('isActiveIpd', true)" class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:border-indigo-500 hover:shadow-md transition-all cursor-pointer group">
                        <p class="text-sm font-bold text-gray-600 uppercase tracking-wider group-hover:text-indigo-700">กำลัง Admit (IPD)</p>
                        <p class="mt-2 text-4xl font-extrabold text-indigo-600">{{ stats.ipdActive }}</p>
                        <p class="text-xs text-indigo-400 mt-1 font-medium group-hover:text-indigo-600">คลิกเพื่อดูรายชื่อ</p>
                    </div>
                    <div @click="setFilter('isReadmit30d', true)" class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:border-red-500 hover:shadow-md transition-all cursor-pointer group">
                        <p class="text-sm font-bold text-gray-600 uppercase tracking-wider group-hover:text-red-700">Re-admit (30 วัน)</p>
                        <p class="mt-2 text-4xl font-extrabold text-red-600">{{ stats.readmission30d }}</p>
                        <p class="text-xs text-red-400 mt-1 font-medium group-hover:text-red-600">คลิกเพื่อดูรายชื่อ</p>
                    </div>
                    <div @click="setFilter('isLvefLess50', true)" class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 hover:border-amber-500 hover:shadow-md transition-all cursor-pointer group">
                        <p class="text-sm font-bold text-gray-600 uppercase tracking-wider group-hover:text-amber-700">LVEF < 50%</p>
                        <p class="mt-2 text-4xl font-extrabold text-amber-600">{{ stats.lvefLess50 }}</p>
                        <p class="text-xs text-amber-400 mt-1 font-medium group-hover:text-amber-600">คลิกเพื่อดูรายชื่อ</p>
                    </div>
                </div>

                <!-- Charts Area -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Pie Chart: LVEF -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col items-center">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 self-start">สัดส่วน LVEF (%)</h3>
                        <div id="lvef-pie-chart" class="w-full h-48 relative flex justify-center"></div>
                        <p class="text-xs text-gray-500 mt-2">คลิกที่กราฟเพื่อกรองข้อมูล</p>
                    </div>

                    <!-- Pie Chart: Insurance -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col items-center">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 self-start">สิทธิการรักษา</h3>
                        <div id="insurance-pie-chart" class="w-full h-48 relative flex justify-center"></div>
                        <p class="text-xs text-gray-500 mt-2">คลิกที่กราฟเพื่อกรองข้อมูล</p>
                    </div>

                    <!-- Pie Chart: Age -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col items-center">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 self-start">ช่วงอายุผู้ป่วย</h3>
                        <div id="age-pie-chart" class="w-full h-48 relative flex justify-center"></div>
                        <p class="text-xs text-gray-500 mt-2">คลิกที่กราฟเพื่อกรองข้อมูล</p>
                    </div>

                    <!-- Bar Chart: District (Full Width) -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 lg:col-span-3">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-900">การกระจายตัวผู้ป่วย</h3>
                            <div class="flex items-center gap-2 text-sm font-bold">
                                <span class="text-gray-500">ระดับ:</span>
                                <span v-for="(item, index) in locationBreadcrumb" :key="index" :class="index === locationBreadcrumb.length - 1 ? 'text-indigo-600' : 'text-gray-700'">
                                    {{ item }}
                                    <i v-if="index !== locationBreadcrumb.length - 1" class="fa-solid fa-chevron-right text-xs text-gray-400 mx-1"></i>
                                </span>
                                <button v-if="locationLevel !== 'province'" @click="resetLocationFilter" class="ml-2 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-700">รีเซ็ต</button>
                            </div>
                        </div>
                        <div id="district-bar-chart" class="w-full h-64"></div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: IPD Tracking -->
            <div v-if="activeTab === 2" class="space-y-6">
                <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex-wrap gap-2">
                    <h2 class="text-xl font-extrabold text-gray-900 flex items-center gap-2">
                        <i class="fa-solid fa-hospital-user text-indigo-600"></i> ติดตามผู้ป่วย
                        <select v-model="trackingStatusFilter" @change="setFilter('status', trackingStatusFilter)" class="ml-2 border-2 border-indigo-100 rounded-lg px-3 py-1 text-base font-bold text-indigo-700 focus:outline-none bg-indigo-50">
                            <option value="IPD">IPD</option>
                            <option value="OPD">OPD</option>
                        </select>
                    </h2>
                    <div class="flex items-center gap-2 flex-wrap">
                        <!-- Ward Filter -->
                        <div class="flex items-center gap-1">
                             <span class="text-xs font-bold text-gray-600">{{ trackingStatusFilter === 'IPD' ? 'Ward:' : 'Last Ward:' }}</span>
                             <select :value="filter.ward" @change="(e) => setFilter('ward', e.target.value === 'all' ? undefined : e.target.value)" class="border-2 border-gray-300 rounded-lg px-2 py-1.5 text-sm font-bold text-gray-900 focus:border-indigo-500 focus:ring-0 max-w-[120px]">
                                <option value="all">ทุก Ward</option>
                                <option v-for="w in uniqueWards" :key="w" :value="w">{{ w }}</option>
                             </select>
                        </div>
                        
                        <div class="flex items-center gap-1">
                            <span class="text-xs font-bold text-gray-600">Admit:</span>
                            <input type="date" :value="filter.dateRangeStart" @change="(e) => setFilter('dateRangeStart', e.target.value)"
                                class="border-2 border-gray-300 rounded-lg px-2 py-1.5 text-sm font-bold text-gray-900 focus:border-indigo-500 focus:ring-0 w-32">
                            <span class="text-xs font-bold text-gray-600">ถึง</span>
                            <input type="date" :value="filter.dateRangeEnd" @change="(e) => setFilter('dateRangeEnd', e.target.value)"
                                class="border-2 border-gray-300 rounded-lg px-2 py-1.5 text-sm font-bold text-gray-900 focus:border-indigo-500 focus:ring-0 w-32">
                        </div>

                        <button @click="openPatientModal" class="ml-2 bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-md flex items-center gap-2 transition-all">
                            <i class="fa-solid fa-plus"></i> รับใหม่ (Admit)
                        </button>
                    </div>
                </div>

                <!-- KPI Cards IPD -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div @click="setFilter('isRespiFailure', true)" class="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm cursor-pointer hover:shadow-md transition-all group">
                        <span class="block text-gray-600 text-xs font-bold uppercase group-hover:text-red-700">ใส่ท่อช่วยหายใจ (Respi Failure)</span>
                        <span class="block text-2xl font-extrabold text-red-600 mt-1">{{ stats.respiFailureCount }}</span>
                    </div>
                    <div @click="setFilter('isDiureticAdjust', true)" class="bg-white p-4 rounded-xl border-l-4 border-blue-500 shadow-sm cursor-pointer hover:shadow-md transition-all group">
                        <span class="block text-gray-600 text-xs font-bold uppercase group-hover:text-blue-700">ปรับยาขับปัสสาวะ</span>
                        <span class="block text-2xl font-extrabold text-blue-600 mt-1">{{ stats.diureticAdjustCount }}</span>
                    </div>
                    <div @click="setFilter('isTripleTherapy', true)" class="bg-white p-4 rounded-xl border-l-4 border-green-500 shadow-sm cursor-pointer hover:shadow-md transition-all group">
                        <span class="block text-gray-600 text-xs font-bold uppercase group-hover:text-green-700">ได้รับยา GDMT ครบ (3+)</span>
                        <span class="block text-2xl font-extrabold text-green-600 mt-1">{{ ipdStats.tripleTherapyCount }}</span>
                    </div>
                    <div @click="setFilter('hasNextAppointment', true)" class="bg-white p-4 rounded-xl border-l-4 border-purple-500 shadow-sm cursor-pointer hover:shadow-md transition-all group">
                        <span class="block text-gray-600 text-xs font-bold uppercase group-hover:text-purple-700">มีนัดติดตาม OPD แล้ว</span>
                        <span class="block text-2xl font-extrabold text-purple-600 mt-1">{{ stats.appointmentCount }}</span>
                    </div>
                </div>

                <!-- Etiology & Meds Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">สาเหตุ Heart Failure (Etiology)</h3>
                        <div id="etiology-chart" class="h-64 flex justify-center"></div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-900">สัดส่วนยาที่ได้รับก่อนกลับบ้าน</h3>
                            <div class="flex bg-gray-100 rounded-lg p-1">
                                <button @click="medViewMode = 'combined'"
                                    :class="medViewMode === 'combined' ? 'bg-white shadow-sm text-indigo-700' : ''"
                                    class="px-3 py-1 text-xs font-bold rounded-md transition-all text-gray-600">รวม RAAS</button>
                                <button @click="medViewMode = 'specific'"
                                    :class="medViewMode === 'specific' ? 'bg-white shadow-sm text-indigo-700' : ''"
                                    class="px-3 py-1 text-xs font-bold rounded-md transition-all text-gray-600">แยก ARNi</button>
                            </div>
                        </div>

                        <div class="space-y-5">
                            <template v-if="medViewMode === 'combined'">
                                <div class="relative cursor-pointer group" @click="setFilter('medication', 'acei_arb_arni')">
                                    <div class="flex mb-1 items-center justify-between">
                                        <span class="text-sm font-bold text-gray-900 group-hover:text-blue-700">ACEI / ARB / ARNI</span>
                                        <span class="text-sm font-bold text-blue-600">{{ ipdStats.aceiArbArni.toFixed(0) }}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" :style="{ width: ipdStats.aceiArbArni + '%' }"></div>
                                    </div>
                                </div>
                            </template>
                            <template v-else>
                                <div class="relative cursor-pointer group" @click="setFilter('medication', 'acei_arb')">
                                    <div class="flex mb-1 items-center justify-between">
                                        <span class="text-sm font-bold text-gray-900 group-hover:text-indigo-700">ACEI / ARB (Only)</span>
                                        <span class="text-sm font-bold text-indigo-600">{{ ipdStats.aceiArb.toFixed(0) }}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-indigo-600 h-3 rounded-full transition-all duration-500" :style="{ width: ipdStats.aceiArb + '%' }"></div>
                                    </div>
                                </div>
                                <div class="relative cursor-pointer group" @click="setFilter('medication', 'arni')">
                                    <div class="flex mb-1 items-center justify-between">
                                        <span class="text-sm font-bold text-gray-900 group-hover:text-pink-700">ARNi</span>
                                        <span class="text-sm font-bold text-pink-600">{{ ipdStats.arni.toFixed(0) }}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-pink-600 h-3 rounded-full transition-all duration-500" :style="{ width: ipdStats.arni + '%' }"></div>
                                    </div>
                                </div>
                            </template>

                            <div class="relative cursor-pointer group" @click="setFilter('medication', 'betaBlocker')">
                                <div class="flex mb-1 items-center justify-between">
                                    <span class="text-sm font-bold text-gray-900 group-hover:text-emerald-700">Beta Blocker</span>
                                    <span class="text-sm font-bold text-emerald-600">{{ ipdStats.betaBlocker.toFixed(0) }}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-emerald-600 h-3 rounded-full transition-all duration-500" :style="{ width: ipdStats.betaBlocker + '%' }"></div>
                                </div>
                            </div>

                            <div class="relative cursor-pointer group" @click="setFilter('medication', 'mra')">
                                <div class="flex mb-1 items-center justify-between">
                                    <span class="text-sm font-bold text-gray-900 group-hover:text-amber-700">MRA</span>
                                    <span class="text-sm font-bold text-amber-600">{{ ipdStats.mra.toFixed(0) }}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-amber-600 h-3 rounded-full transition-all duration-500" :style="{ width: ipdStats.mra + '%' }"></div>
                                </div>
                            </div>
                             
                             <div class="relative cursor-pointer group" @click="setFilter('medication', 'sglt2i')">
                                <div class="flex mb-1 items-center justify-between">
                                    <span class="text-sm font-bold text-gray-900 group-hover:text-cyan-700">SGLT2i</span>
                                    <span class="text-sm font-bold text-cyan-600">{{ ipdStats.sglt2i.toFixed(0) }}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-cyan-600 h-3 rounded-full transition-all duration-500" :style="{ width: ipdStats.sglt2i + '%' }"></div>
                                </div>
                            </div>
                            
                            <p class="text-xs font-bold text-gray-600 pt-2 text-center bg-gray-100 px-3 py-1 rounded-full">
                                <i class="fa-solid fa-arrow-pointer mr-1"></i> คลิกที่กราฟเพื่อกรองรายชื่อด้านล่าง
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: OPD Clinic -->
            <div v-if="activeTab === 3" class="space-y-6">
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Calendar Side -->
                    <div class="w-full lg:w-1/3 bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-extrabold text-gray-900 flex items-center gap-2">
                                <i class="fa-regular fa-calendar text-indigo-600"></i> ปฏิทินวันนัด
                            </h3>
                            <div class="flex gap-1">
                                <button @click="changeMonth(-1)" class="p-1 rounded hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-chevron-left"></i></button>
                                <span class="text-sm font-bold text-gray-900 self-center min-w-[80px] text-center">
                                    {{ formatDate(viewDate, 'MMM yyyy') }}
                                </span>
                                <button @click="changeMonth(1)" class="p-1 rounded hover:bg-gray-100 text-gray-600"><i class="fa-solid fa-chevron-right"></i></button>
                            </div>
                        </div>

                        <!-- Location Filter for Calendar -->
                        <div class="mb-4">
                            <select @change="e => setFilter('appointmentLocation', e.target.value === 'all' ? undefined : e.target.value)" class="w-full border border-gray-200 rounded-lg px-3 py-1.5 text-xs font-bold text-gray-700 focus:outline-none">
                                <option value="all">แสดงทุกคลินิก</option>
                                <option value="OPD Cardio LPN (พุธ)">OPD Cardio LPN (พุธ)</option>
                                <option value="OPD HF ป่าซาง">OPD HF ป่าซาง</option>
                                <option value="OPD HF ลี้">OPD HF ลี้</option>
                                <option value="HF clinic (ส่งต่อ LPN)">HF clinic (ส่งต่อ LPN)</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2">
                            <div class="font-bold text-gray-400">อา</div>
                            <div class="font-bold text-gray-900">จ</div>
                            <div class="font-bold text-gray-900">อ</div>
                            <div class="font-bold text-gray-900">พ</div>
                            <div class="font-bold text-gray-900">พฤ</div>
                            <div class="font-bold text-gray-900">ศ</div>
                            <div class="font-bold text-gray-400">ส</div>
                        </div>
                        <div class="grid grid-cols-7 gap-1">
                            <div v-for="day in calendarDays" :key="day.dateStr"
                                @click="selectCalendarDate(day.dateStr)"
                                :class="[
                                    day.hasAppt ? 'bg-indigo-50 text-indigo-700 font-extrabold cursor-pointer hover:bg-indigo-100' : 'text-gray-400 hover:bg-gray-50',
                                    filter.appointmentDate === day.dateStr ? 'ring-2 ring-indigo-600' : ''
                                ]"
                                class="h-10 rounded-lg flex items-center justify-center relative transition-all text-sm">
                                {{ day.dayNum }}
                                <span v-if="day.hasAppt" class="absolute bottom-1 w-1.5 h-1.5 bg-indigo-500 rounded-full"></span>
                            </div>
                        </div>
                        <div class="mt-6 pt-6 border-t border-gray-100">
                            <button @click="openPatientModal" class="w-full py-3 bg-indigo-600 text-white rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 flex justify-center items-center gap-2">
                                <i class="fa-solid fa-clipboard-list"></i> บันทึกการตรวจ OPD
                            </button>
                        </div>
                    </div>

                    <!-- Details Side -->
                    <div class="w-full lg:w-2/3">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">สัดส่วนยาที่ได้รับปัจจุบัน (OPD)</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                            <div @click="setFilter('isTripleTherapy', true)" class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center hover:border-indigo-500 cursor-pointer group transition-all">
                                <div class="text-3xl font-extrabold text-gray-900 group-hover:text-indigo-700">{{ opdStats.tripleTherapyCount }}</div>
                                <div class="text-xs font-bold text-gray-600 uppercase mt-1">ได้ยาครบ 3 ตัว</div>
                            </div>
                            <div @click="setFilter('medication', 'betaBlocker')" class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center hover:border-emerald-500 cursor-pointer group transition-all">
                                <div class="text-3xl font-extrabold text-emerald-600 group-hover:text-emerald-700">{{ opdStats.betaBlocker.toFixed(0) }}%</div>
                                <div class="text-xs font-bold text-gray-600 uppercase mt-1">Beta-Blocker</div>
                            </div>
                            <div @click="setFilter('medication', 'mra')" class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center hover:border-amber-500 cursor-pointer group transition-all">
                                <div class="text-3xl font-extrabold text-amber-600 group-hover:text-amber-700">{{ opdStats.mra.toFixed(0) }}%</div>
                                <div class="text-xs font-bold text-gray-600 uppercase mt-1">MRA</div>
                            </div>
                            <div @click="setFilter('medication', 'sglt2i')" class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm text-center hover:border-cyan-500 cursor-pointer group transition-all">
                                <div class="text-3xl font-extrabold text-cyan-600 group-hover:text-cyan-700">{{ opdStats.sglt2i.toFixed(0) }}%</div>
                                <div class="text-xs font-bold text-gray-600 uppercase mt-1">SGLT2i</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shared Patient Table -->
            <div class="mt-8 bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                    <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2 flex-wrap">
                        <i class="fa-solid fa-list-ul text-gray-400"></i> รายชื่อผู้ป่วย
                        <!-- Badges for active filters -->
                         <span v-if="filter.isActiveIpd" class="ml-2 text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded-md">กำลัง Admit</span>
                         <span v-if="filter.isReadmit30d" class="ml-2 text-xs font-bold bg-orange-100 text-orange-700 px-2 py-1 rounded-md">Re-admit (30d)</span>
                         <span v-if="filter.isLvefLess50" class="ml-2 text-xs font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded-md">LVEF < 50%</span>
                         <span v-if="filter.dateRangeStart" class="ml-2 text-xs font-bold bg-gray-100 text-gray-700 px-2 py-1 rounded-md">ช่วงเวลา: {{filter.dateRangeStart}} - {{filter.dateRangeEnd}}</span>
                         <span v-if="filter.lvefGroup" class="ml-2 text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md">LVEF: {{filter.lvefGroup}}</span>
                         <span v-if="filter.district" class="ml-2 text-xs font-bold bg-purple-100 text-purple-700 px-2 py-1 rounded-md">อำเภอ: {{filter.district}}</span>
                         <span v-if="filter.subDistrict" class="ml-2 text-xs font-bold bg-purple-50 text-purple-700 px-2 py-1 rounded-md">ตำบล: {{filter.subDistrict}}</span>
                         <span v-if="filter.appointmentLocation" class="ml-2 text-xs font-bold bg-gray-100 text-gray-700 px-2 py-1 rounded-md">คลินิก: {{filter.appointmentLocation}}</span>
                         <span v-if="filter.appointmentDate" class="ml-2 text-xs font-bold bg-indigo-100 text-indigo-700 px-2 py-1 rounded-md">วันนัด: {{filter.appointmentDate}}</span>
                         <span v-if="filter.ward" class="ml-2 text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded-md">Ward: {{filter.ward}}</span>
                    </h3>
                    <div class="flex gap-4 items-center">
                        <button @click="downloadCsv" class="text-xs font-bold text-indigo-600 hover:text-indigo-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-indigo-50 transition-colors">
                            <i class="fa-solid fa-file-csv"></i> ส่งออก CSV
                        </button>
                        <button @click="clearFilter" class="text-xs font-bold text-gray-500 hover:text-gray-700 transition-colors">ล้างตัวกรอง</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">HN</th>
                                <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">ชื่อ-สกุล</th>
                                <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">สถานะ</th>
                                <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">LVEF</th>
                                <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">ที่อยู่</th>
                                <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">ยาที่ได้รับ</th>
                                <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">Admit ล่าสุด</th>
                                <th class="px-6 py-3 text-left text-xs font-extrabold text-gray-700 uppercase tracking-wider">วันนัดถัดไป</th>
                                <th class="px-6 py-3 text-right text-xs font-extrabold text-gray-700 uppercase tracking-wider">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-for="p in paginatedPatients" :key="p.id" class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                                    {{ p.hn }}
                                    <div v-if="p.an" class="text-[10px] text-gray-500">AN: {{p.an}}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    {{ p.firstName }} {{ p.lastName }}
                                    <div class="text-xs text-gray-500 font-normal">อายุ: {{ p.age }}, {{ p.gender }}</div>
                                    <div class="text-[10px] text-gray-400 font-normal">{{ p.insurance }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="p.status === 'IPD' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'"
                                        class="px-2 inline-flex text-xs leading-5 font-bold rounded-full">
                                        {{ p.status }}
                                    </span>
                                    <span v-if="p.status === 'IPD' && p.admissionCount" class="ml-1 px-2 inline-flex text-[10px] font-bold bg-gray-100 text-gray-600 rounded-full border border-gray-200">
                                        Admit #{{ p.admissionCount }}
                                    </span>
                                    <div v-if="p.admitWard && (p.status === 'IPD' || activeTab === 2)" class="text-[10px] text-gray-500 font-bold mt-1">
                                        {{ p.status === 'IPD' ? 'Ward:' : 'Last:' }} {{p.admitWard}}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <span class="text-sm font-bold mr-2" :class="{'text-red-600': p.lvef < 40, 'text-green-600': p.lvef >= 50}">{{ p.lvef }}%</span>
                                        <i v-if="p.lvef < 40" class="fa-solid fa-heart-crack text-red-400 text-xs"></i>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">
                                    <div>อ.{{ p.address.district }}</div>
                                    <div class="text-xs text-indigo-500 cursor-pointer hover:underline" @click="setFilter('subDistrict', p.address.subDistrict)">ต.{{ p.address.subDistrict }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex gap-1">
                                        <span v-if="p.meds.acei_arb" class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-blue-100 text-blue-800" title="ACEI/ARB">R</span>
                                        <span v-if="p.meds.arni" class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-pink-100 text-pink-800" title="ARNi">AR</span>
                                        <span v-if="p.meds.betaBlocker" class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-emerald-100 text-emerald-800" title="Beta Blocker">B</span>
                                        <span v-if="p.meds.mra" class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-amber-100 text-amber-800" title="MRA">M</span>
                                        <span v-if="p.meds.sglt2i" class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-cyan-100 text-cyan-800" title="SGLT2i">S</span>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-700 font-medium">{{ p.lastAdmission || '-' }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-700 font-medium">
                                    <div>{{ p.nextAppointment?.date || '-' }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button @click="openEdit(p)" class="text-indigo-600 hover:text-indigo-900 font-bold hover:bg-indigo-50 px-2 py-1 rounded">
                                        <i class="fa-regular fa-pen-to-square"></i> แก้ไข
                                    </button>
                                    <button v-if="userRole === 'admin'" @click="confirmDelete(p)" class="text-red-600 hover:text-red-900 font-bold hover:bg-red-50 px-2 py-1 rounded ml-1">
                                        <i class="fa-regular fa-trash-can"></i> ลบ
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                 <!-- Pagination -->
                <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 flex items-center justify-between sm:px-6">
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                         <div>
                            <p class="text-sm text-gray-700 font-bold">
                                แสดง <span class="font-medium text-indigo-600">{{ (currentPage - 1) * itemsPerPage + 1 }}</span>
                                ถึง <span class="font-medium text-indigo-600">{{ paginationEnd }}</span>
                                จาก <span class="font-medium text-indigo-600">{{ filteredPatients.length }}</span> รายการ
                            </p>
                        </div>
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                <button @click="currentPage--" :disabled="currentPage === 1"
                                    class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                    <span class="sr-only">Previous</span>
                                    <i class="fa-solid fa-chevron-left h-5 w-5 p-1"></i>
                                </button>
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-bold text-gray-700">
                                    หน้า {{ currentPage }} / {{ totalPages }}
                                </span>
                                <button @click="currentPage++" :disabled="currentPage >= totalPages"
                                    class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50">
                                    <span class="sr-only">Next</span>
                                    <i class="fa-solid fa-chevron-right h-5 w-5 p-1"></i>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Universal Modal -->
        <div v-if="showModal" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 backdrop-blur-sm flex items-center justify-center no-print">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl m-4 flex flex-col max-h-[90vh] modal-container">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50 rounded-t-xl no-print">
                    <h3 class="text-lg font-extrabold text-gray-900">
                        {{ formState.id ? 'แก้ไขข้อมูลผู้ป่วย' : 'ลงทะเบียนผู้ป่วยใหม่' }}
                    </h3>
                    <button @click="closeModal" class="text-gray-400 hover:text-gray-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <div class="p-6 overflow-y-auto flex-1 print-modal-content" id="printable-area">
                    <!-- Row 1 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">HN</label>
                            <input type="text" list="hnList" v-model="formState.hn" @blur="checkExistingHn" class="w-full border border-gray-300 bg-white text-gray-900 rounded-lg px-3 py-2 font-bold focus:border-indigo-500 focus:outline-none" placeholder="ค้นหา HN หรือกรอกใหม่">
                            <datalist id="hnList">
                                <option v-for="p in patients" :key="p.hn" :value="p.hn">{{ p.firstName }} {{ p.lastName }}</option>
                            </datalist>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">ชื่อ</label>
                            <input type="text" v-model="formState.firstName" class="w-full border border-gray-300 bg-white text-gray-900 rounded-lg px-3 py-2 font-bold focus:border-indigo-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">นามสกุล</label>
                            <input type="text" v-model="formState.lastName" class="w-full border border-gray-300 bg-white text-gray-900 rounded-lg px-3 py-2 font-bold focus:border-indigo-500 focus:outline-none">
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">อายุ</label>
                            <input type="number" v-model="formState.age" class="w-full border border-gray-300 bg-white text-gray-900 rounded-lg px-3 py-2 font-bold focus:border-indigo-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">เพศ</label>
                            <select v-model="formState.gender" class="w-full border border-gray-300 bg-white text-gray-900 rounded-lg px-3 py-2 font-bold focus:border-indigo-500 focus:outline-none">
                                <option value="ชาย">ชาย</option>
                                <option value="หญิง">หญิง</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">สถานะ</label>
                            <select v-model="formState.status" class="w-full border border-gray-300 bg-white text-gray-900 rounded-lg px-3 py-2 font-bold focus:border-indigo-500 focus:outline-none">
                                <option value="OPD">OPD</option>
                                <option value="IPD">IPD</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 mb-1">LVEF (%)</label>
                            <input type="number" v-model="formState.lvef" class="w-full border border-gray-300 bg-white text-indigo-600 rounded-lg px-3 py-2 font-bold focus:border-indigo-500 focus:outline-none">
                        </div>
                    </div>

                    <div v-if="formState.status === 'IPD'" class="mb-4 p-3 bg-red-50 border border-red-100 rounded-lg">
                        <div class="mb-3">
                            <label class="block text-xs font-bold text-red-700 mb-1">AN</label>
                            <input type="text" v-model="formState.an" class="w-full border border-red-200 bg-white rounded-lg px-3 py-2 font-bold focus:border-red-500 focus:outline-none text-gray-700">
                        </div>
                        <label class="block text-xs font-bold text-red-700 mb-1">สาเหตุ Heart Failure (Etiology)</label>
                        <select v-model="formState.etiology" class="w-full border border-red-200 bg-white rounded-lg px-3 py-2 font-bold focus:border-red-500 focus:outline-none text-gray-700">
                            <option value="" disabled>-- กรุณาเลือกสาเหตุ --</option>
                            <option value="Ischemic">Ischemic</option>
                            <option value="Non-ischemic">Non-ischemic</option>
                            <option value="Other (HTN heart disease, Pulmonary hypertension, Severe VHD)">Other</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-700 mb-1">สิทธิการรักษา</label>
                        <input type="text" list="insuranceList" v-model="formState.insurance" class="w-full border border-gray-300 bg-white text-gray-900 rounded-lg px-3 py-2 font-bold focus:border-indigo-500 focus:outline-none">
                        <datalist id="insuranceList">
                            <option v-for="ins in uniqueInsurances" :key="ins" :value="ins"></option>
                        </datalist>
                    </div>

                    <!-- Address -->
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="text-sm font-bold text-gray-800 mb-2 border-b border-gray-200 pb-1">ที่อยู่ปัจจุบัน</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600">เลขที่</label>
                                <input type="text" v-model="formState.address.number" class="w-full border border-gray-300 bg-white rounded px-2 py-1.5 text-sm font-medium mt-1 text-gray-900">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600">ตำบล</label>
                                <input type="text" list="subDistrictList" v-model="formState.address.subDistrict" class="w-full border border-gray-300 bg-white rounded px-2 py-1.5 text-sm font-medium mt-1 text-gray-900">
                                <datalist id="subDistrictList">
                                    <option v-for="item in uniqueSubDistricts" :key="item" :value="item"></option>
                                </datalist>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600">อำเภอ</label>
                                <input type="text" list="districtList" v-model="formState.address.district" class="w-full border border-gray-300 bg-white rounded px-2 py-1.5 text-sm font-medium mt-1 text-gray-900">
                                <datalist id="districtList">
                                    <option v-for="item in uniqueDistricts" :key="item" :value="item"></option>
                                </datalist>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600">จังหวัด</label>
                                <input type="text" list="provinceList" v-model="formState.address.province" class="w-full border border-gray-300 bg-white rounded px-2 py-1.5 text-sm font-medium mt-1 text-gray-900">
                                <datalist id="provinceList">
                                    <option v-for="item in uniqueProvinces" :key="item" :value="item"></option>
                                </datalist>
                            </div>
                        </div>
                    </div>

                    <!-- Treatment Info -->
                    <div class="mb-4 p-4 bg-indigo-50 rounded-lg border border-indigo-100">
                        <h4 class="text-sm font-bold text-indigo-900 mb-2 border-b border-indigo-200 pb-1">ข้อมูลการรักษา (Treatment)</h4>
                        
                        <div v-if="formState.status === 'IPD'" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                            <div>
                                <label class="block text-xs font-bold text-gray-700">Ward ที่ Admit</label>
                                <input type="text" list="wardList" v-model="formState.admitWard" class="w-full border border-gray-300 bg-white rounded px-2 py-1.5 text-sm font-medium mt-1 text-gray-900" placeholder="ระบุ Ward หรือเลือก">
                                <datalist id="wardList">
                                    <option v-for="w in uniqueWards" :key="w" :value="w"></option>
                                </datalist>
                            </div>
                            <div class="flex flex-col justify-end pb-1 gap-2">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="formState.isRespiFailure" class="form-checkbox h-4 w-4 text-red-600 rounded border-gray-300">
                                    <span class="ml-2 text-sm font-bold text-gray-700">ใส่ท่อช่วยหายใจ (Respi Failure)</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" v-model="formState.isDiureticAdjust" class="form-checkbox h-4 w-4 text-blue-600 rounded border-gray-300">
                                    <span class="ml-2 text-sm font-bold text-gray-700">มีการปรับยาขับปัสสาวะ</span>
                                </label>
                            </div>
                        </div>

                        <div class="mt-2">
                            <label class="block text-xs font-bold text-gray-700">
                                {{ formState.status === 'IPD' ? 'รายละเอียดการรักษา (Admission Note)' : 'บันทึกผลการตรวจ (OPD Note)' }}
                            </label>
                            <textarea v-model="formState.admissionNote" class="w-full border border-gray-300 bg-white rounded px-2 py-1.5 text-sm font-medium mt-1 text-gray-900 h-16" 
                                :placeholder="formState.status === 'IPD' ? 'บันทึก Course of hospital, Complication...' : 'บันทึกอาการ, V/S, Physical exam...'">
                            </textarea>
                        </div>
                        
                        <div v-if="formState.status === 'IPD'" class="mt-4 border-t border-indigo-200 pt-3">
                             <label class="block text-xs font-bold text-indigo-700 mb-2">แนบไฟล์เวชระเบียน (PDF) - สำหรับ IPD History Review</label>
                             <div class="flex items-center gap-2">
                                <div class="relative flex-1">
                                    <input type="file" ref="pdfInput" accept="application/pdf" @change="handleFileUpload" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                </div>
                                <div v-if="uploadingFile" class="text-indigo-600">
                                    <i class="fa-solid fa-circle-notch fa-spin"></i>
                                </div>
                             </div>
                             <div v-if="formState.scanFileUrl" class="mt-2 flex items-center gap-2 bg-green-50 p-2 rounded border border-green-200">
                                 <i class="fa-solid fa-file-pdf text-red-500 text-lg"></i>
                                 <a :href="formState.scanFileUrl" target="_blank" class="text-xs font-bold text-green-700 hover:underline truncate flex-1">
                                     {{ formState.scanFileName || 'ไฟล์แนบ.pdf' }}
                                 </a>
                                 <button @click="formState.scanFileUrl = null; formState.scanFileName = null" class="text-gray-400 hover:text-red-500 px-2">
                                     <i class="fa-solid fa-xmark"></i>
                                 </button>
                             </div>
                        </div>
                        
                        <div v-if="formState.status === 'IPD'" class="mt-2">
                             <label class="block text-xs font-bold text-gray-700">เบอร์โทรศัพท์ (สำหรับติดตามอาการ)</label>
                             <input type="tel" v-model="formState.phone" class="w-full border border-gray-300 bg-white rounded px-2 py-1.5 text-sm font-medium mt-1 text-gray-900" placeholder="0xx-xxx-xxxx">
                        </div>
                    </div>

                    <!-- Meds -->
                     <div class="mb-4">
                        <h4 class="text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                           <i class="fa-solid fa-pills text-indigo-600"></i>
                           {{ formState.status === 'IPD' ? 'ยาที่ได้รับก่อนกลับบ้าน (Pre-discharge)' : 'ยาที่ได้รับปัจจุบัน' }}
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-4 rounded-lg border border-gray-200">
                             <div class="col-span-1 md:col-span-2 space-y-2 pb-2 border-b border-gray-100">
                                 <label class="text-xs font-bold text-gray-700 block">ยากลุ่ม RAAS Blockade</label>
                                 <div class="flex gap-4 mt-1">
                                    <div class="inline-flex items-center cursor-pointer" @click="formState.meds.acei_arb = true; formState.meds.arni = false">
                                         <div :class="formState.meds.acei_arb ? 'bg-indigo-600 border-indigo-600' : 'bg-white border-gray-300'" class="h-4 w-4 border rounded-full flex items-center justify-center">
                                             <div v-if="formState.meds.acei_arb" class="h-2 w-2 bg-white rounded-full"></div>
                                         </div>
                                         <span class="ml-2 text-sm font-bold text-gray-800">ACEI / ARB</span>
                                    </div>
                                    <div class="inline-flex items-center cursor-pointer" @click="formState.meds.arni = true; formState.meds.acei_arb = false">
                                         <div :class="formState.meds.arni ? 'bg-pink-600 border-pink-600' : 'bg-white border-gray-300'" class="h-4 w-4 border rounded-full flex items-center justify-center">
                                             <div v-if="formState.meds.arni" class="h-2 w-2 bg-white rounded-full"></div>
                                         </div>
                                         <span class="ml-2 text-sm font-bold text-gray-800">ARNi</span>
                                    </div>
                                    <div class="inline-flex items-center cursor-pointer" @click="formState.meds.acei_arb = false; formState.meds.arni = false">
                                         <div :class="!formState.meds.acei_arb && !formState.meds.arni ? 'bg-gray-600 border-gray-600' : 'bg-white border-gray-300'" class="h-4 w-4 border rounded-full flex items-center justify-center">
                                             <div v-if="!formState.meds.acei_arb && !formState.meds.arni" class="h-2 w-2 bg-white rounded-full"></div>
                                         </div>
                                         <span class="ml-2 text-sm font-medium text-gray-600">ไม่ได้รับยา</span>
                                    </div>
                                 </div>
                                 <!-- RAAS Target Dose -->
                                 <div v-if="formState.meds.acei_arb || formState.meds.arni" class="mt-2 ml-1">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" v-model="formState.targetDoseReached.acei_arb_arni" class="form-checkbox h-4 w-4 text-green-600 rounded border-gray-300">
                                        <span class="ml-2 text-xs font-bold text-green-700">Target dose reached</span>
                                    </label>
                                 </div>
                             </div>
                             
                             <div class="flex flex-col p-2 hover:bg-gray-50 rounded">
                                 <label class="flex items-center space-x-3 cursor-pointer">
                                     <input type="checkbox" v-model="formState.meds.betaBlocker" class="form-checkbox h-5 w-5 text-emerald-600 rounded border-gray-300">
                                     <span class="text-sm font-bold text-gray-700">Beta-Blocker</span>
                                 </label>
                                 <div v-if="formState.meds.betaBlocker" class="mt-1 ml-8">
                                     <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" v-model="formState.targetDoseReached.betaBlocker" class="form-checkbox h-4 w-4 text-green-600 rounded border-gray-300">
                                        <span class="ml-2 text-xs font-bold text-green-700">Target dose reached</span>
                                    </label>
                                </div>
                             </div>

                             <div class="flex flex-col p-2 hover:bg-gray-50 rounded">
                                 <label class="flex items-center space-x-3 cursor-pointer">
                                     <input type="checkbox" v-model="formState.meds.mra" class="form-checkbox h-5 w-5 text-amber-600 rounded border-gray-300">
                                     <span class="text-sm font-bold text-gray-700">MRA</span>
                                 </label>
                                 <div v-if="formState.meds.mra" class="mt-1 ml-8">
                                     <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" v-model="formState.targetDoseReached.mra" class="form-checkbox h-4 w-4 text-green-600 rounded border-gray-300">
                                        <span class="ml-2 text-xs font-bold text-green-700">Target dose reached</span>
                                    </label>
                                </div>
                             </div>

                             <label class="flex items-center space-x-3 cursor-pointer p-2 hover:bg-gray-50 rounded">
                                 <input type="checkbox" v-model="formState.meds.sglt2i" class="form-checkbox h-5 w-5 text-cyan-600 rounded border-gray-300">
                                 <span class="text-sm font-bold text-gray-700">SGLT2i</span>
                             </label>
                        </div>
                     </div>
                     
                     <!-- Dates -->
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                             <label class="block text-xs font-bold text-gray-700 mb-1">วันที่ Admit ล่าสุด</label>
                             <div class="flex gap-2">
                                <input type="date" v-model="formState.lastAdmission" class="w-full border border-gray-300 bg-white rounded-lg px-3 py-2 font-medium focus:border-indigo-500 outline-none text-gray-900">
                                <div class="w-32">
                                   <input type="number" v-model="formState.admissionCount" class="w-full border border-gray-300 bg-white rounded-lg px-2 py-2 font-medium text-center focus:border-indigo-500 outline-none text-gray-900" placeholder="ลำดับ Admit">
                                </div>
                             </div>
                        </div>
                        <div>
                             <label class="block text-xs font-bold text-gray-700 mb-1">วันนัดถัดไป</label>
                             <div v-if="formState.nextAppointment" class="flex flex-col gap-2">
                                 <input type="date" v-model="formState.nextAppointment.date" class="w-full border border-gray-300 bg-white rounded-lg px-3 py-2 font-medium focus:border-indigo-500 outline-none text-gray-900">
                                 <select v-model="formState.nextAppointment.location" class="w-full border border-gray-300 bg-white rounded-lg px-3 py-2 font-medium text-sm focus:border-indigo-500 outline-none text-gray-900">
                                   <option value="OPD Cardio LPN (พุธ)">OPD Cardio LPN (พุธ)</option>
                                   <option value="OPD HF ป่าซาง">OPD HF ป่าซาง</option>
                                   <option value="OPD HF ลี้">OPD HF ลี้</option>
                                   <option value="HF clinic (ส่งต่อ LPN)">HF clinic (ส่งต่อ LPN)</option>
                                </select>
                                <input type="text" v-model="formState.nextAppointment.detail" class="w-full border border-gray-300 bg-white rounded-lg px-3 py-2 font-medium text-sm focus:border-indigo-500 outline-none text-gray-900" placeholder="รายละเอียด (เช่น เจาะเลือด, Echo)">
                             </div>
                             <div v-else>
                                 <button @click="formState.nextAppointment = {date: '', location: 'OPD Cardio LPN (พุธ)', detail: ''}" class="text-indigo-600 text-xs font-bold underline">เพิ่มวันนัด</button>
                             </div>
                        </div>
                     </div>
                </div>

                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between gap-3 rounded-b-xl no-print">
                    <button @click="printModal" class="px-5 py-2 rounded-lg text-indigo-700 border border-indigo-200 font-bold hover:bg-indigo-50 transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-print"></i> Print
                    </button>
                    <div class="flex gap-3">
                         <button v-if="formState.status === 'IPD' && formState.id" @click="confirmDischarge" class="px-5 py-2 rounded-lg bg-pink-100 text-pink-700 font-bold hover:bg-pink-200 transition-colors border border-pink-200 flex items-center gap-2">
                            <i class="fa-solid fa-person-walking-arrow-right"></i> จำหน่าย (Discharge)
                        </button>
                        <button @click="closeModal" class="px-5 py-2 rounded-lg text-gray-700 font-bold hover:bg-gray-200 transition-colors">ยกเลิก</button>
                        <button @click="savePatient" :disabled="isSaving" class="px-6 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all flex items-center gap-2">
                            <i v-if="isSaving" class="fa-solid fa-circle-notch fa-spin"></i>
                            {{ isSaving ? 'กำลังบันทึก...' : 'บันทึกข้อมูล' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        </main>
        
        <!-- Logic -->
        <script>
            const { createApp, ref, computed, onMounted, watch, nextTick, reactive } = Vue;

            createApp({
                setup() {
                    const patients = ref([]);
                    const isLoading = ref(false);
                    const isGasEnvironment = ref(false);
                    const userRole = ref(null);
                    const isLoggedIn = ref(false);
                    const activeTab = ref(1);
                    const showModal = ref(false);
                    const isSaving = ref(false);
                    const uploadingFile = ref(false); // State for file upload spinner
                    const fileInput = ref(null);
                    const csvInput = ref(null);
                    const pdfInput = ref(null); // Ref for the PDF input in modal

                    const loginForm = reactive({ username: '', password: '' });
                    const formState = ref({});
                    
                    const filter = reactive({
                        lvefGroup: undefined, province: undefined, district: undefined, subDistrict: undefined,
                        etiology: undefined, insurance: undefined, ageGroup: undefined,
                        dateRangeStart: undefined, dateRangeEnd: undefined, appointmentDate: undefined,
                        appointmentLocation: undefined, medication: undefined, status: undefined, ward: undefined,
                        isActiveIpd: false, isReadmit30d: false, isLvefLess50: false, isTripleTherapy: false,
                        isRespiFailure: false, isDiureticAdjust: false, hasNextAppointment: false
                    });

                    const locationLevel = ref('province');
                    const locationBreadcrumb = ref(['ทั้งหมด']);
                    const trackingStatusFilter = ref('IPD');
                    const medViewMode = ref('combined');
                    const currentPage = ref(1);
                    const itemsPerPage = 50;
                    const viewDate = ref(new Date());

                    onMounted(() => {
                        checkEnvironment();
                        loadData();
                        setInterval(() => { if (patients.value.length > 0) loadData(true); }, 60000);
                    });

                    watch([activeTab, () => patients.value], async () => {
                        await nextTick();
                        if (activeTab.value === 1) renderChartsTab1();
                        else if (activeTab.value === 2) {
                            renderChartsTab2();
                            if (!filter.dateRangeStart && !filter.dateRangeEnd) {
                                const end = new Date();
                                const start = new Date();
                                start.setDate(end.getDate() - 30);
                                filter.dateRangeStart = start.toISOString().split('T')[0];
                                filter.dateRangeEnd = end.toISOString().split('T')[0];
                            }
                            if (filter.status !== trackingStatusFilter.value) filter.status = trackingStatusFilter.value;
                        } else if (activeTab.value === 3) {
                             if(filter.status !== 'OPD') filter.status = 'OPD';
                        }
                    });

                    watch(filter, () => {
                        currentPage.value = 1;
                        if(activeTab.value === 1) renderChartsTab1();
                        if(activeTab.value === 2) renderChartsTab2();
                    }, { deep: true });

                    const checkEnvironment = () => { if (typeof google !== 'undefined' && google.script) isGasEnvironment.value = true; };
                    
                    const loadData = (silent = false) => {
                        if (!silent) isLoading.value = true;
                        if (isGasEnvironment.value) {
                            google.script.run.withSuccessHandler((response) => {
                                try {
                                    const data = JSON.parse(response);
                                    if (Array.isArray(data)) patients.value = data;
                                } catch (e) { console.error(e); }
                                isLoading.value = false;
                            }).withFailureHandler(() => isLoading.value = false).getPatients();
                        } else {
                            if (patients.value.length === 0) generateMockData();
                            setTimeout(() => isLoading.value = false, 500);
                        }
                    };

                    const getFiscalYear = (date) => {
                        const month = date.getMonth(); 
                        const year = date.getFullYear();
                        return (month >= 9) ? (year + 1).toString() : year.toString();
                    };

                    const savePatient = async () => {
                         isSaving.value = true;
                         const p = JSON.parse(JSON.stringify(formState.value));
                         if (!p.id) p.id = 'P' + Math.floor(Math.random() * 1000000);
                         const existing = patients.value.find(x => x.id === p.id);
                         if (p.status === 'IPD') {
                            const admissionDate = p.lastAdmission ? new Date(p.lastAdmission) : new Date();
                            const currentFiscalYear = getFiscalYear(admissionDate);
                            if (existing) {
                                if (!existing.history) existing.history = [];
                                if (existing.an && existing.an !== p.an) {
                                    const historyEntry = {
                                        an: existing.an, admissionDate: existing.lastAdmission, dischargeDate: existing.dischargeDate,
                                        ward: existing.admitWard, etiology: existing.etiology, fiscalYear: existing.fiscalYear,
                                        // Preserve scan file in history if it exists on the previous record being archived
                                        scanFileUrl: existing.scanFileUrl,
                                        scanFileName: existing.scanFileName
                                    };
                                    p.history = [...existing.history, historyEntry];
                                    
                                    // If starting a NEW admission event (different AN), we might want to clear the 'current' scan file
                                    // from the main object so the new admission starts clean, OR keep it if user intends to replace.
                                    // Usually, a new AN means new paperwork.
                                    // However, formState is bound to UI. If user didn't clear it in UI, it stays.
                                    // If this save is triggered by "Admit New", formState would be fresh. 
                                    // If this is editing an existing patient to update status to IPD, we rely on user input.
                                } else { p.history = [...existing.history]; }
                            } else { p.history = []; }
                            
                            if (!p.admissionCount) {
                                let newCount = 1;
                                if (existing && existing.fiscalYear === currentFiscalYear) {
                                    newCount = (existing.an !== p.an) ? (existing.admissionCount || 0) + 1 : (existing.admissionCount || 1);
                                }
                                p.admissionCount = newCount;
                            }

                            if (existing) {
                                const prevDischarge = existing.dischargeDate ? new Date(existing.dischargeDate) : (existing.lastAdmission ? new Date(existing.lastAdmission) : null);
                                if (prevDischarge) {
                                    const diffTime = Math.abs(admissionDate.getTime() - prevDischarge.getTime());
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                    const isNewEvent = existing.status === 'OPD' || existing.an !== p.an;
                                    if (isNewEvent) p.isReadmission = diffDays < 30;
                                    else p.isReadmission = existing.isReadmission;
                                }
                            } else p.isReadmission = false;
                            p.fiscalYear = currentFiscalYear;
                         }

                         if (p.status === 'IPD' && p.nextAppointment?.date) {
                             p.status = 'OPD';
                             if (!p.dischargeDate) p.dischargeDate = new Date().toISOString().split('T')[0];
                         }

                         if (isGasEnvironment.value) {
                             await new Promise(resolve => {
                                 google.script.run.withSuccessHandler((res) => {
                                     const r = JSON.parse(res);
                                     if (r.success) {
                                         updateLocalPatient(p);
                                         Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อย', 'success');
                                         showModal.value = false;
                                     } else Swal.fire('Error', r.error, 'error');
                                     resolve();
                                 }).savePatient(JSON.stringify(p));
                             });
                         } else {
                             updateLocalPatient(p);
                             await new Promise(r => setTimeout(r, 800));
                             Swal.fire('Mock Save', 'Saved locally', 'success');
                             showModal.value = false;
                         }
                         isSaving.value = false;
                    };
                    
                    const handleFileUpload = (event) => {
                        const file = event.target.files[0];
                        if (!file) return;
                        
                        if (file.type !== 'application/pdf') {
                            Swal.fire('Error', 'กรุณาอัปโหลดไฟล์ PDF เท่านั้น', 'error');
                            event.target.value = '';
                            return;
                        }

                        uploadingFile.value = true;
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = function() {
                            const base64 = reader.result; // Data URL
                            const hn = formState.value.hn || 'UNKNOWN_HN';
                            const an = formState.value.an || 'NO_AN';
                            const filename = file.name;

                            if (isGasEnvironment.value) {
                                google.script.run.withSuccessHandler((res) => {
                                    uploadingFile.value = false;
                                    if (res.success) {
                                        formState.value.scanFileUrl = res.url;
                                        formState.value.scanFileName = res.name;
                                        Swal.fire('สำเร็จ', 'อัปโหลดไฟล์เรียบร้อยแล้ว', 'success');
                                    } else {
                                        Swal.fire('Upload Failed', res.error, 'error');
                                    }
                                }).withFailureHandler((err) => {
                                    uploadingFile.value = false;
                                    Swal.fire('Error', err.toString(), 'error');
                                }).uploadFileToDrive(base64, filename, hn, an);
                            } else {
                                // Mock behavior
                                setTimeout(() => {
                                    uploadingFile.value = false;
                                    formState.value.scanFileUrl = '#mock-link-to-drive';
                                    formState.value.scanFileName = hn + '_' + an + '_' + filename;
                                    Swal.fire('Mock Upload', 'File uploaded (simulated)', 'success');
                                }, 1500);
                            }
                        };
                        reader.onerror = function (error) {
                            uploadingFile.value = false;
                            console.error('Error: ', error);
                        };
                    };

                    const updateLocalPatient = (p) => {
                         const idx = patients.value.findIndex(x => x.id === p.id);
                         if(idx > -1) patients.value[idx] = p;
                         else patients.value.unshift(p);
                    };

                    const confirmDelete = (p) => {
                        Swal.fire({
                             title: 'ยืนยันการลบ?', text: `${p.firstName} ${p.lastName}`, icon: 'warning',
                             showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ลบ'
                        }).then((result) => {
                             if (result.isConfirmed) {
                                 if(isGasEnvironment.value) {
                                     google.script.run.withSuccessHandler((res) => {
                                         const r = JSON.parse(res);
                                         if(r.success) { patients.value = patients.value.filter(x => x.id !== p.id); Swal.fire('Deleted!', '', 'success'); }
                                     }).deletePatient(p.id);
                                 } else {
                                     patients.value = patients.value.filter(x => x.id !== p.id); Swal.fire('Deleted (Mock)', '', 'success');
                                 }
                             }
                        });
                    };
                    
                    const generateSummaryHtml = (p) => {
                        return `
                        <div class="text-left font-sans text-sm text-gray-800 p-2">
                            <div class="flex justify-between items-end border-b-2 border-indigo-600 pb-2 mb-4">
                                <div>
                                    <h1 class="text-xl font-extrabold text-indigo-800 m-0">สรุปข้อมูลผู้ป่วย (Patient Summary)</h1>
                                    <p class="text-xs text-gray-500 m-0">เครือข่ายหัวใจล้มเหลว จ.ลำพูน (Lamphun HF Network)</p>
                                </div>
                                <div class="text-right text-xs">
                                    <p><strong>Date:</strong> ${new Date().toLocaleDateString('th-TH')}</p>
                                </div>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 mb-4">
                                <table class="w-full text-sm">
                                    <tr>
                                        <td class="font-bold text-gray-600 w-20">ชื่อ-สกุล:</td>
                                        <td class="font-bold text-gray-900">${p.firstName} ${p.lastName}</td>
                                        <td class="font-bold text-gray-600 w-16">HN:</td>
                                        <td class="text-gray-900">${p.hn}</td>
                                    </tr>
                                    <tr>
                                        <td class="font-bold text-gray-600">อายุ:</td>
                                        <td class="text-gray-900">${p.age} ปี (${p.gender})</td>
                                        <td class="font-bold text-gray-600">AN:</td>
                                        <td class="text-gray-900 font-bold">${p.an || '-'}</td>
                                    </tr>
                                    <tr>
                                        <td class="font-bold text-gray-600">สิทธิ:</td>
                                        <td colspan="3" class="text-gray-900">${p.insurance}</td>
                                    </tr>
                                    <tr>
                                        <td class="font-bold text-gray-600">ที่อยู่:</td>
                                        <td colspan="3" class="text-gray-900 text-xs">${p.address.number} ต.${p.address.subDistrict} อ.${p.address.district} จ.${p.address.province}</td>
                                    </tr>
                                </table>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="border border-gray-200 rounded-lg p-3">
                                     <h3 class="font-bold text-indigo-700 border-b border-gray-100 pb-1 mb-2">ข้อมูลทางคลินิก</h3>
                                     <p class="text-xs mb-1"><span class="font-bold">LVEF:</span> <span class="${p.lvef < 40 ? 'text-red-600 font-bold' : 'text-green-600'}">${p.lvef}%</span></p>
                                     <p class="text-xs mb-1"><span class="font-bold">Etiology:</span> ${p.etiology}</p>
                                     <p class="text-xs mb-1"><span class="font-bold">Last Ward:</span> ${p.admitWard || '-'}</p>
                                </div>
                                <div class="border border-gray-200 rounded-lg p-3">
                                     <h3 class="font-bold text-indigo-700 border-b border-gray-100 pb-1 mb-2">ภาวะแทรกซ้อน</h3>
                                     <p class="text-xs mb-1"><span class="font-bold">Respi Failure:</span> ${p.isRespiFailure ? '🔴 Yes' : '⚪ No'}</p>
                                     <p class="text-xs mb-1"><span class="font-bold">Diuretic Adjust:</span> ${p.isDiureticAdjust ? '🔵 Yes' : '⚪ No'}</p>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h3 class="font-bold text-gray-800 mb-1">📝 Admission Note / Hospital Course</h3>
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs text-gray-800 whitespace-pre-line leading-relaxed">
                                    ${p.admissionNote || 'ไม่มีข้อมูลบันทึก'}
                                </div>
                            </div>

                            <div class="mb-4">
                                <h3 class="font-bold text-gray-800 mb-1">💊 ยาและการรักษา (GDMT Optimization)</h3>
                                <table class="w-full border-collapse border border-gray-200 text-xs">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="border border-gray-200 p-2 text-left">Group</th>
                                            <th class="border border-gray-200 p-2 text-center">Status</th>
                                            <th class="border border-gray-200 p-2 text-center">Target Dose?</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-200 p-2 font-bold text-gray-700">RAAS (ACEI/ARB/ARNi)</td>
                                            <td class="border border-gray-200 p-2 text-center">
                                                ${(p.meds.acei_arb || p.meds.arni) ? (p.meds.arni ? '<span class="text-pink-600 font-bold">ARNi</span>' : '<span class="text-blue-600 font-bold">ACEI/ARB</span>') : '<span class="text-gray-400">-</span>'}
                                            </td>
                                            <td class="border border-gray-200 p-2 text-center">
                                                 ${(p.meds.acei_arb || p.meds.arni) ? (p.targetDoseReached.acei_arb_arni ? '✅ Yes' : '⚠️ No') : '-'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-200 p-2 font-bold text-gray-700">Beta-Blocker</td>
                                            <td class="border border-gray-200 p-2 text-center">
                                                ${p.meds.betaBlocker ? '<span class="text-green-600 font-bold">Received</span>' : '<span class="text-gray-400">-</span>'}
                                            </td>
                                            <td class="border border-gray-200 p-2 text-center">
                                                ${p.meds.betaBlocker ? (p.targetDoseReached.betaBlocker ? '✅ Yes' : '⚠️ No') : '-'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-200 p-2 font-bold text-gray-700">MRA</td>
                                            <td class="border border-gray-200 p-2 text-center">
                                                ${p.meds.mra ? '<span class="text-amber-600 font-bold">Received</span>' : '<span class="text-gray-400">-</span>'}
                                            </td>
                                            <td class="border border-gray-200 p-2 text-center">
                                                ${p.meds.mra ? (p.targetDoseReached.mra ? '✅ Yes' : '⚠️ No') : '-'}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-200 p-2 font-bold text-gray-700">SGLT2i</td>
                                            <td class="border border-gray-200 p-2 text-center">
                                                ${p.meds.sglt2i ? '<span class="text-cyan-600 font-bold">Received</span>' : '<span class="text-gray-400">-</span>'}
                                            </td>
                                            <td class="border border-gray-200 p-2 text-center text-gray-400">N/A</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                                <h3 class="font-extrabold text-indigo-900 mb-2 border-b border-indigo-200 pb-1 flex items-center gap-2">
                                    <i class="fa-regular fa-calendar-check"></i> นัดหมาย & การติดต่อ
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-xs text-indigo-800 mb-1"><strong>วันนัดถัดไป:</strong> ${p.nextAppointment?.date || 'ไม่ระบุ'}</p>
                                        <p class="text-xs text-indigo-800 mb-1"><strong>คลินิก:</strong> ${p.nextAppointment?.location || '-'}</p>
                                        <p class="text-xs text-indigo-800 mb-1"><strong>รายละเอียด:</strong> ${p.nextAppointment?.detail || '-'}</p>
                                    </div>
                                    <div class="border-l border-indigo-200 pl-4">
                                        <p class="text-xs text-indigo-800 mb-1"><strong>เบอร์โทรศัพท์ผู้ป่วย:</strong></p>
                                        <p class="text-lg font-bold text-indigo-900">${p.phone || '-'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    };
                    
                    const confirmDischarge = async () => {
                        const original = formState.value;
                        if(!original.id) return;
                        
                        // Clone so we don't modify form state prematurely
                        const p = JSON.parse(JSON.stringify(original));

                        // Temporary status update for display (not saved yet)
                        p.status = 'OPD';
                        p.dischargeDate = new Date().toISOString().split('T')[0];
                        
                        const htmlContent = generateSummaryHtml(p);

                        const result = await Swal.fire({
                            html: htmlContent,
                            showCancelButton: true,
                            confirmButtonText: 'ยืนยัน & แจ้งเตือน',
                            cancelButtonText: 'แก้ไข',
                            confirmButtonColor: '#059669',
                            width: '650px',
                            customClass: {
                                popup: 'text-left' 
                            }
                        });

                        if (result.isConfirmed) {
                            formState.value = p; // Update local form state with discharge changes
                            sendTelegramNotification(p);
                            savePatient();
                        }
                    };
                    
                    const printHtml = (htmlContent) => {
                        const printWindow = window.open('', '', 'width=800,height=600');
                        printWindow.document.write(`
                            <html>
                            <head>
                                <title>Patient Summary</title>
                                <script src="https://cdn.tailwindcss.com"><\/script>
                                <style>
                                    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
                                    body { font-family: 'Sarabun', sans-serif; -webkit-print-color-adjust: exact; }
                                </style>
                            </head>
                            <body class="p-4">
                                ${htmlContent}
                                <script>
                                    setTimeout(() => { window.print(); window.close(); }, 1000);
                                <\/script>
                            </body>
                            </html>
                        `);
                        printWindow.document.close();
                    };

                    const printModal = async () => {
                        const p = formState.value;
                        const htmlContent = generateSummaryHtml(p);
                        
                        const result = await Swal.fire({
                            html: htmlContent,
                            showCancelButton: true,
                            confirmButtonText: '<i class="fa-solid fa-print"></i> Print',
                            cancelButtonText: 'Close',
                            confirmButtonColor: '#4f46e5',
                            width: '650px',
                            customClass: { popup: 'text-left' }
                        });
                        
                        if (result.isConfirmed) {
                            printHtml(htmlContent);
                        }
                    };

                    const sendTelegramNotification = async (p) => {
                        const token = "8515704509:AAHo9tZEpLy9ckdvmL1HvX0nPN6O8Z4TTWc";
                        const chatId = "-5039290792";
                        
                        const medEmoji = (val) => val ? '✅' : '❌';
                        const message = `
🏥 <b>HF Registry Discharge Alert</b>
--------------------------------
<b>HN:</b> ${p.hn}
<b>Name:</b> ${p.firstName} ${p.lastName}
<b>Age:</b> ${p.age} | <b>LVEF:</b> ${p.lvef}%

📝 <b>Admission Note:</b>
${p.admissionNote || '-'}

💊 <b>Discharge Meds (GDMT):</b>
${medEmoji(p.meds.acei_arb || p.meds.arni)} RAAS (ACEI/ARB/ARNi)
${medEmoji(p.meds.betaBlocker)} Beta-Blocker
${medEmoji(p.meds.mra)} MRA
${medEmoji(p.meds.sglt2i)} SGLT2i

🗓 <b>Next Appt:</b> ${p.nextAppointment?.date || 'N/A'}
📍 <b>Loc:</b> ${p.nextAppointment?.location || '-'}
📋 <b>Detail:</b> ${p.nextAppointment?.detail || '-'}
📞 <b>Tel:</b> ${p.phone || '-'}
                        `;

                        // Attempt Client-side fetch first (might fail CORS in strict browsers without proxy)
                        // In GAS environment, usually server-side is better, but this is a requested pure-JS implementation in the provided file.
                        try {
                            await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    chat_id: chatId,
                                    text: message,
                                    parse_mode: 'HTML'
                                })
                            });
                            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'แจ้งเตือน Telegram แล้ว', timer: 2000, showConfirmButton: false });
                        } catch (e) {
                            console.error("Telegram Notification Failed (Client-side):", e);
                            // Fallback: If running in GAS, we might want to call a server function here, 
                            // but since we only have frontend code access, we just log it.
                            // Often 'no-cors' allows sending but not reading response.
                             fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ chat_id: chatId, text: message, parse_mode: 'HTML' })
                            });
                        }
                    };
                    
                    const triggerCsvImport = () => csvInput.value.click();

                    const onCsvSelected = (event) => {
                        const file = event.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            const text = e.target.result;
                            await processCsvImport(text);
                            event.target.value = ''; 
                        };
                        reader.readAsText(file);
                    };

                    const processCsvImport = async (csvText) => {
                        try {
                            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
                            if (lines.length < 2) return; 

                            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                            
                            const newPatients = [];
                            
                            for (let i = 1; i < lines.length; i++) {
                                const row = parseCsvLine(lines[i]); 
                                if(row.length < 5) continue; 

                                const p = mapCsvRowToPatient(row, headers);
                                if(p) newPatients.push(p);
                            }

                            if (newPatients.length === 0) {
                                Swal.fire('Error', 'ไม่พบข้อมูลที่ถูกต้องใน CSV', 'error');
                                return;
                            }

                            const confirmed = await Swal.fire({
                                title: 'ยืนยันการนำเข้า',
                                text: `พบข้อมูล ${newPatients.length} รายการ. ข้อมูลที่มี HN ตรงกันจะถูกอัปเดต`,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'นำเข้า'
                            });

                            if (confirmed.isConfirmed) {
                                mergeAndSavePatients(newPatients);
                            }

                        } catch (e) {
                            console.error(e);
                            Swal.fire('Error', 'CSV parsing failed: ' + e.message, 'error');
                        }
                    };

                    const parseCsvLine = (text) => {
                        const result = [];
                        let start = 0;
                        let inQuotes = false;
                        for (let i = 0; i < text.length; i++) {
                            if (text[i] === '"') inQuotes = !inQuotes;
                            else if (text[i] === ',' && !inQuotes) {
                                result.push(text.substring(start, i).replace(/^"|"$/g, '').replace(/""/g, '"'));
                                start = i + 1;
                            }
                        }
                        result.push(text.substring(start).replace(/^"|"$/g, '').replace(/""/g, '"'));
                        return result;
                    }

                    const mapCsvRowToPatient = (row, headers) => {
                        const idx = (name) => headers.indexOf(name);
                        
                        const hn = row[idx('HN')];
                        if(!hn) return null;

                        const nameParts = (row[idx('ชื่อ-สกุล')] || '').split(' ');
                        const firstName = nameParts[0] || '';
                        const lastName = nameParts.slice(1).join(' ') || '';

                        const addrStr = row[idx('ที่อยู่')] || '';
                        const addrMatch = addrStr.match(/^(.*?) ต\.(.*?) อ\.(.*?) จ\.(.*?)$/);
                        const address = addrMatch ? {
                            number: addrMatch[1], subDistrict: addrMatch[2], district: addrMatch[3], province: addrMatch[4]
                        } : { number: addrStr, subDistrict: '', district: '', province: '' };

                        const medStr = row[idx('ยา')] || '';
                        const meds = {
                            acei_arb: medStr.includes('ACEI/ARB'),
                            arni: medStr.includes('ARNi'),
                            betaBlocker: medStr.includes('BB'),
                            mra: medStr.includes('MRA'),
                            sglt2i: medStr.includes('SGLT2i')
                        };

                        return {
                            hn: hn,
                            an: row[idx('AN')],
                            firstName, lastName,
                            age: parseInt(row[idx('อายุ')]) || 0,
                            gender: row[idx('เพศ')] || 'ชาย',
                            insurance: row[idx('สิทธิการรักษา')] || '',
                            status: row[idx('สถานะ')] || 'OPD',
                            admissionCount: parseInt(row[idx('Admit Count')]) || 1,
                            isReadmission: (row[idx('Re-admit(30d)')] || '').toLowerCase() === 'yes',
                            admitWard: row[idx('Ward')] || '',
                            isRespiFailure: (row[idx('RespiFail')] || '').toLowerCase() === 'yes',
                            lvef: parseInt(row[idx('LVEF')]) || 0,
                            address,
                            meds,
                            lastAdmission: row[idx('วันที่ Admit ล่าสุด')] || '',
                            nextAppointment: {
                                date: row[idx('วันนัดถัดไป')] || '',
                                location: row[idx('สถานที่นัด')] || '',
                                detail: '' 
                            },
                            targetDoseReached: { acei_arb_arni: false, betaBlocker: false, mra: false },
                            history: [] 
                        };
                    }

                    const mergeAndSavePatients = (newPatients) => {
                        const current = [...patients.value];
                        let added = 0;
                        let updated = 0;

                        newPatients.forEach(np => {
                            const index = current.findIndex(p => p.hn === np.hn);
                            if(index > -1) {
                                const existing = current[index];
                                np.id = existing.id;
                                np.history = existing.history;
                                current[index] = { ...existing, ...np }; 
                                updated++;
                            } else {
                                np.id = 'P' + Math.floor(Math.random() * 1000000);
                                current.unshift(np);
                                added++;
                            }
                        });

                        if(isGasEnvironment.value) {
                            Swal.fire({ title: 'Saving...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                            google.script.run.withSuccessHandler(() => {
                                patients.value = current;
                                Swal.fire('สำเร็จ', `เพิ่ม: ${added}, อัปเดต: ${updated}`, 'success');
                            }).saveAllPatients(JSON.stringify(current));
                        } else {
                            patients.value = current;
                            Swal.fire('Mock Save', `Added: ${added}, Updated: ${updated}`, 'success');
                        }
                    }
                    
                    // ... (Remaining filtering, analytical, pagination, chart rendering and helper methods) ...
                    // (Ensure all filtering logic below is preserved)
                    
                    const filteredPatients = computed(() => {
                        const f = filter;
                        return patients.value.filter(p => {
                            let match = true;
                            if (f.status) match = match && p.status === f.status;
                            if (f.isActiveIpd) match = match && p.status === 'IPD' && !p.dischargeDate;
                            if (f.isReadmit30d) match = match && !!p.isReadmission;
                            if (f.isLvefLess50) match = match && p.lvef < 50;
                            if (f.lvefGroup) {
                                if (f.lvefGroup === '<20%') match = match && p.lvef < 20;
                                else if (f.lvefGroup === '20-30%') match = match && p.lvef >= 20 && p.lvef < 30;
                                else if (f.lvefGroup === '30-40%') match = match && p.lvef >= 30 && p.lvef < 40;
                                else if (f.lvefGroup === '40-50%') match = match && p.lvef >= 40 && p.lvef < 50;
                                else if (f.lvefGroup === '>50%') match = match && p.lvef >= 50;
                            }
                            if (f.dateRangeStart || f.dateRangeEnd) {
                                const d = p.lastAdmission;
                                if (d) {
                                    if (f.dateRangeStart && d < f.dateRangeStart) match = false;
                                    if (f.dateRangeEnd && d > f.dateRangeEnd) match = false;
                                } else {
                                    match = false;
                                }
                            }
                            if (f.province) match = match && p.address.province === f.province;
                            if (f.district) match = match && p.address.district === f.district;
                            if (f.subDistrict) match = match && p.address.subDistrict === f.subDistrict;
                            if (f.etiology) match = match && p.etiology === f.etiology;
                            if (f.insurance) match = match && p.insurance === f.insurance;
                            
                            if (f.ageGroup) {
                                if(f.ageGroup === '<40') match = match && p.age < 40;
                                else if(f.ageGroup === '41-60') match = match && p.age >= 41 && p.age <= 60;
                                else if(f.ageGroup === '61-80') match = match && p.age >= 61 && p.age <= 80;
                                else if(f.ageGroup === '>80') match = match && p.age > 80;
                            }
                            if (f.appointmentDate) match = match && p.nextAppointment?.date === f.appointmentDate;
                            if (f.appointmentLocation) match = match && p.nextAppointment?.location === f.appointmentLocation;
                            
                            if (f.medication) {
                                if (f.medication === 'acei_arb') match = match && p.meds.acei_arb;
                                else if (f.medication === 'arni') match = match && p.meds.arni;
                                else if (f.medication === 'acei_arb_arni') match = match && (p.meds.acei_arb || p.meds.arni);
                                else if (f.medication === 'betaBlocker') match = match && p.meds.betaBlocker;
                                else if (f.medication === 'mra') match = match && p.meds.mra;
                                else if (f.medication === 'sglt2i') match = match && p.meds.sglt2i;
                            }
                            if (f.ward) {
                                match = match && p.admitWard === f.ward;
                            }

                            if (f.isTripleTherapy) match = match && (p.meds.acei_arb || p.meds.arni) && p.meds.betaBlocker && p.meds.mra;
                            if (f.isRespiFailure) match = match && !!p.isRespiFailure;
                            if (f.isDiureticAdjust) match = match && !!p.isDiureticAdjust;
                            if (f.hasNextAppointment) match = match && !!p.nextAppointment?.date;

                            return match;
                        });
                    });

                    const stats = computed(() => {
                        const all = patients.value;
                        const filtered = filteredPatients.value;
                        return {
                            total: all.length,
                            ipdActive: all.filter(p => p.status === 'IPD' && !p.dischargeDate).length,
                            readmission30d: all.filter(p => p.isReadmission).length,
                            lvefLess50: all.filter(p => p.lvef < 50).length,
                            respiFailureCount: filtered.filter(p => p.isRespiFailure).length,
                            diureticAdjustCount: filtered.filter(p => p.isDiureticAdjust).length,
                            appointmentCount: filtered.filter(p => !!p.nextAppointment?.date).length
                        };
                    });
                    
                    const calculateMedStats = (list) => {
                        const total = list.length || 1;
                        return {
                            aceiArb: list.filter(p => p.meds.acei_arb).length / total * 100,
                            arni: list.filter(p => p.meds.arni).length / total * 100,
                            aceiArbArni: list.filter(p => p.meds.acei_arb || p.meds.arni).length / total * 100,
                            betaBlocker: list.filter(p => p.meds.betaBlocker).length / total * 100,
                            mra: list.filter(p => p.meds.mra).length / total * 100,
                            sglt2i: list.filter(p => p.meds.sglt2i).length / total * 100,
                            tripleTherapyCount: list.filter(p => (p.meds.acei_arb || p.meds.arni) && p.meds.betaBlocker && p.meds.mra).length
                        };
                    };

                    const ipdStats = computed(() => calculateMedStats(filteredPatients.value));
                    const opdStats = computed(() => calculateMedStats(patients.value.filter(p => p.status === 'OPD')));

                    const paginatedPatients = computed(() => {
                        const start = (currentPage.value - 1) * itemsPerPage;
                        return filteredPatients.value.slice(start, start + itemsPerPage);
                    });
                    const totalPages = computed(() => Math.ceil(filteredPatients.value.length / itemsPerPage));
                    const paginationEnd = computed(() => Math.min(currentPage.value * itemsPerPage, filteredPatients.value.length));

                    const renderChartsTab1 = () => {
                       const all = patients.value;
                       renderPie('#lvef-pie-chart', ['<20%', '20-30%', '30-40%', '40-50%', '>50%'], 
                            all.map(p => {
                                if(p.lvef < 20) return '<20%';
                                if(p.lvef < 30) return '20-30%';
                                if(p.lvef < 40) return '30-40%';
                                if(p.lvef < 50) return '40-50%';
                                return '>50%';
                            }), ['#dc2626', '#ea580c', '#d97706', '#2563eb', '#16a34a'], 'lvefGroup'
                       );
                       renderPie('#insurance-pie-chart', null, all.map(p => p.insurance || 'Other'), d3.schemeSet2, 'insurance');
                       renderPie('#age-pie-chart', ['<40', '41-60', '61-80', '>80'],
                            all.map(p => {
                                if(p.age <= 40) return '<40';
                                if(p.age <= 60) return '41-60';
                                if(p.age <= 80) return '61-80';
                                return '>80';
                            }), ['#818cf8', '#6366f1', '#4f46e5', '#3730a3'], 'ageGroup'
                       );
                       renderDistrictChart();
                    };

                    const renderChartsTab2 = () => {
                        const data = filteredPatients.value.map(p => p.etiology || 'Other');
                        renderPie('#etiology-chart', null, data, ['#db2777', '#7c3aed', '#0d9488'], 'etiology');
                    };

                    const renderPie = (selector, domain, dataList, colors, filterKey) => {
                        const container = d3.select(selector);
                        container.selectAll('*').remove();
                        const counts = {};
                        dataList.forEach(k => counts[k] = (counts[k] || 0) + 1);
                        const data = Object.entries(counts).map(([key, value]) => ({ key, value }));
                        if(data.length === 0) return;
                        const width = 200, height = 180, radius = Math.min(width, height) / 2;
                        const svg = container.append('svg').attr('width', width).attr('height', height)
                            .append('g').attr('transform', `translate(${width/2},${height/2})`);
                        const color = d3.scaleOrdinal().domain(domain || data.map(d=>d.key)).range(colors);
                        const pie = d3.pie().value(d => d.value);
                        const arc = d3.arc().innerRadius(filterKey === 'etiology' ? 0 : 40).outerRadius(radius - 5);
                        svg.selectAll('path').data(pie(data)).enter().append('path')
                            .attr('d', arc).attr('fill', d => color(d.data.key))
                            .attr('stroke', 'white').style('stroke-width', '2px').style('cursor', 'pointer')
                            .on('click', (e, d) => setFilter(filterKey, d.data.key))
                            .append('title').text(d => `${d.data.key}: ${d.data.value}`);
                    };

                    const renderDistrictChart = () => {
                         const container = d3.select('#district-bar-chart');
                         container.selectAll('*').remove();
                         const rect = container.node().getBoundingClientRect();
                         if(rect.width === 0) return;
                         const level = locationLevel.value;
                         const list = filteredPatients.value;
                         const counts = {};
                         list.forEach(p => {
                             let k = 'ไม่ระบุ';
                             if(level === 'province') k = p.address.province || k;
                             else if(level === 'district') k = p.address.district || k;
                             else k = p.address.subDistrict || k;
                             counts[k] = (counts[k] || 0) + 1;
                         });
                         const data = Object.entries(counts).map(([key, value]) => ({ key, value })).sort((a,b) => b.value - a.value);
                         const margin = {top: 20, right: 20, bottom: 40, left: 40};
                         const width = rect.width - margin.left - margin.right;
                         const height = 250 - margin.top - margin.bottom;
                         const svg = container.append("svg").attr("width", width + margin.left + margin.right)
                            .attr("height", height + margin.top + margin.bottom).append("g")
                            .attr("transform", `translate(${margin.left},${margin.top})`);
                         const x = d3.scaleBand().range([0, width]).padding(0.3).domain(data.map(d => d.key));
                         const y = d3.scaleLinear().range([height, 0]).domain([0, d3.max(data, d => d.value) || 10]);
                         svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x))
                            .selectAll("text").style("text-anchor", "end").attr("dx", "-.8em").attr("dy", ".15em").attr("transform", "rotate(-25)");
                         svg.append("g").call(d3.axisLeft(y).ticks(5));
                         svg.selectAll(".bar").data(data).enter().append("rect").attr("class", "bar")
                            .attr("x", d => x(d.key)).attr("width", x.bandwidth()).attr("y", d => y(d.value)).attr("height", d => height - y(d.value))
                            .attr("fill", "#4f46e5").style("cursor", "pointer")
                            .on("click", (e, d) => {
                                 if(level === 'province') {
                                     setFilter('province', d.key);
                                     locationLevel.value = 'district';
                                     locationBreadcrumb.value.push(d.key);
                                 } else if(level === 'district') {
                                     setFilter('district', d.key);
                                     locationLevel.value = 'subDistrict';
                                     locationBreadcrumb.value.push(d.key);
                                 } else {
                                     setFilter('subDistrict', d.key);
                                 }
                            }).append("title").text(d => `${d.value} คน`);
                    };

                    const setFilter = (key, val) => { filter[key] = val; };
                    const clearFilter = () => {
                        Object.keys(filter).forEach(k => filter[k] = undefined);
                        filter.isActiveIpd = false;
                        filter.isReadmit30d = false;
                        filter.isLvefLess50 = false;
                        filter.isTripleTherapy = false;
                        filter.isRespiFailure = false;
                        filter.isDiureticAdjust = false;
                        filter.hasNextAppointment = false;
                        resetLocationFilter();
                    };
                    const resetLocationFilter = () => {
                        locationLevel.value = 'province';
                        locationBreadcrumb.value = ['ทั้งหมด'];
                        filter.province = undefined;
                        filter.district = undefined;
                        filter.subDistrict = undefined;
                    };
                    const filterTotal = () => { clearFilter(); };

                    const login = (role) => {
                        const { username, password } = loginForm;
                        if(role === 'admin' && username === 'ipd' && password === '0811689908') {
                            userRole.value = 'admin'; isLoggedIn.value = true;
                        } else if(role === 'opd' && username === 'opd' && password === '0811689908') {
                            userRole.value = 'opd'; isLoggedIn.value = true;
                        } else {
                            Swal.fire('Login Failed', 'Invalid credentials', 'error');
                        }
                    };
                    const logout = () => { isLoggedIn.value = false; userRole.value = null; };

                    const calendarDays = computed(() => {
                        const y = viewDate.value.getFullYear();
                        const m = viewDate.value.getMonth();
                        const daysInMonth = new Date(y, m + 1, 0).getDate();
                        const days = [];
                        const loc = filter.appointmentLocation;
                        for(let i=1; i<=daysInMonth; i++) {
                            const d = new Date(y, m, i);
                            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                            const hasAppt = patients.value.some(p => {
                                 return p.nextAppointment?.date === dateStr && p.status === 'OPD' && (!loc || p.nextAppointment?.location === loc);
                            });
                            days.push({ dayNum: i, dateStr, hasAppt });
                        }
                        return days;
                    });
                    
                    const changeMonth = (delta) => {
                        const d = new Date(viewDate.value);
                        d.setMonth(d.getMonth() + delta);
                        viewDate.value = d;
                    };
                    const selectCalendarDate = (str) => { setFilter('appointmentDate', str); };
                    const formatDate = (d, fmt) => {
                        const pipe = new Intl.DateTimeFormat('en-US', { month: 'short', year: 'numeric' });
                        return pipe.format(d);
                    };

                    const openPatientModal = () => {
                        formState.value = {
                            id: '', hn: '', an: '', firstName: '', lastName: '', age: null, gender: 'ชาย',
                            insurance: '', address: { number: '', subDistrict: '', district: 'เมือง', province: 'ลำพูน' },
                            status: 'OPD', lvef: null, etiology: '', 
                            admitWard: '', isRespiFailure: false, isDiureticAdjust: false, admissionNote: '', phone: '',
                            meds: { acei_arb: false, arni: false, betaBlocker: false, mra: false, sglt2i: false },
                            targetDoseReached: { acei_arb_arni: false, betaBlocker: false, mra: false },
                            nextAppointment: { date: '', location: 'OPD Cardio LPN (พุธ)', detail: '' },
                            admissionCount: 1, history: [], scanFileUrl: null, scanFileName: null // Added file fields
                        };
                        showModal.value = true;
                    };

                    const openEdit = (p) => {
                        const clone = JSON.parse(JSON.stringify(p));
                        if(!clone.meds) clone.meds = { acei_arb: false, arni: false, betaBlocker: false, mra: false, sglt2i: false };
                        if(!clone.targetDoseReached) clone.targetDoseReached = { acei_arb_arni: false, betaBlocker: false, mra: false };
                        if(!clone.address) clone.address = { number: '', subDistrict: '', district: '', province: '' };
                        if(!clone.nextAppointment) clone.nextAppointment = { date: '', location: '', detail: '' };
                        if(clone.isRespiFailure === undefined) clone.isRespiFailure = false;
                        if(clone.isDiureticAdjust === undefined) clone.isDiureticAdjust = false;
                        if(!clone.admitWard) clone.admitWard = '';
                        if(!clone.admissionNote) clone.admissionNote = '';
                        if(!clone.phone) clone.phone = '';
                        if(!clone.history) clone.history = [];
                        if(!clone.scanFileUrl) clone.scanFileUrl = null;
                        if(!clone.scanFileName) clone.scanFileName = null;
                        formState.value = clone;
                        showModal.value = true;
                    };
                    const closeModal = () => { if(!isSaving.value) showModal.value = false; };
                    
                    const checkExistingHn = () => {
                        const hn = formState.value.hn;
                        if(!hn || formState.value.id) return;
                        const exist = patients.value.find(p => p.hn === hn);
                        if(exist) {
                            const clone = JSON.parse(JSON.stringify(exist));
                            if(clone.isRespiFailure === undefined) clone.isRespiFailure = false;
                            if(clone.isDiureticAdjust === undefined) clone.isDiureticAdjust = false;
                            if(!clone.admitWard) clone.admitWard = '';
                            if(!clone.admissionNote) clone.admissionNote = '';
                            if(!clone.phone) clone.phone = '';
                            if(!clone.targetDoseReached) clone.targetDoseReached = { acei_arb_arni: false, betaBlocker: false, mra: false };
                            if(!clone.history) clone.history = [];
                            if (clone.admissionCount) { clone.admissionCount = clone.admissionCount + 1; } else { clone.admissionCount = 1; }
                            formState.value = clone;
                            Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'ดึงข้อมูลเก่าแล้ว', timer: 1500, showConfirmButton: false });
                        }
                    };

                    const downloadCsv = () => {
                        const headers = ['HN', 'AN', 'ชื่อ-สกุล', 'อายุ', 'เพศ', 'สิทธิการรักษา', 'สถานะ', 'Admit Count', 'Re-admit(30d)', 'Ward', 'RespiFail', 'LVEF', 'ที่อยู่', 'ยา', 'วันที่ Admit ล่าสุด', 'วันนัดถัดไป', 'สถานที่นัด'];
                        const rows = filteredPatients.value.map(p => {
                           const meds = [];
                           if(p.meds.acei_arb) meds.push('ACEI/ARB');
                           if(p.meds.arni) meds.push('ARNi');
                           if(p.meds.betaBlocker) meds.push('BB');
                           if(p.meds.mra) meds.push('MRA');
                           if(p.meds.sglt2i) meds.push('SGLT2i');
                           const sanitize = (val) => `"${(val || '').toString().replace(/"/g, '""')}"`;
                           const fullName = `${p.firstName} ${p.lastName}`;
                           const address = `${p.address.number} ต.${p.address.subDistrict} อ.${p.address.district} จ.${p.address.province}`;
                           return [
                             sanitize(p.hn), sanitize(p.an || ''), sanitize(fullName), sanitize(p.age), sanitize(p.gender), 
                             sanitize(p.insurance), sanitize(p.status), sanitize(p.admissionCount || 1), sanitize(p.isReadmission ? 'Yes' : 'No'),
                             sanitize(p.admitWard || '-'), sanitize(p.isRespiFailure ? 'Yes' : 'No'), sanitize(p.lvef), sanitize(address), 
                             sanitize(meds.join('|')), sanitize(p.lastAdmission), sanitize(p.nextAppointment?.date), sanitize(p.nextAppointment?.location || '-')
                           ].join(',');
                        });
                        const csv = '\uFEFF' + [headers.join(','), ...rows].join('\n');
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement("a");
                        link.setAttribute("href", url);
                        link.setAttribute("download", "hf_registry.csv");
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    };

                    const backupDb = () => {
                        const data = JSON.stringify(patients.value, null, 2);
                        const blob = new Blob([data], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement("a");
                        link.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    };

                    const triggerImport = () => fileInput.value.click();
                    const onFileSelected = (e) => {
                        const file = e.target.files[0];
                        if(!file) return;
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            try {
                                const json = JSON.parse(ev.target.result);
                                if(Array.isArray(json)) {
                                    Swal.fire({
                                        title: 'นำเข้าข้อมูล?', text: `พบ ${json.length} รายการ`,
                                        showCancelButton: true, confirmButtonText: 'ยืนยัน'
                                    }).then((r) => {
                                        if(r.isConfirmed) {
                                            if(isGasEnvironment.value) {
                                                 google.script.run.withSuccessHandler(()=>{ patients.value = json; Swal.fire('สำเร็จ', '', 'success'); }).saveAllPatients(JSON.stringify(json));
                                            } else { patients.value = json; Swal.fire('สำเร็จ', '', 'success'); }
                                        }
                                    });
                                } else { Swal.fire('Error', 'Format ไม่ถูกต้อง', 'error'); }
                            } catch (e) { Swal.fire('Error', 'JSON Parsing Error', 'error'); }
                        };
                        reader.readAsText(file);
                        e.target.value = ''; 
                    };

                    const uniqueProvinces = computed(() => [...new Set(patients.value.map(p => p.address.province).filter(x=>x))].sort());
                    const uniqueDistricts = computed(() => [...new Set(patients.value.map(p => p.address.district).filter(x=>x))].sort());
                    const uniqueSubDistricts = computed(() => [...new Set(patients.value.map(p => p.address.subDistrict).filter(x=>x))].sort());
                    const uniqueInsurances = computed(() => {
                        const existing = patients.value.map(p => p.insurance).filter(x=>x);
                        const defaults = ['บัตรทอง (UC)', 'ประกันสังคม', 'ข้าราชการ (เบิกจ่ายตรง)', 'ชำระเงินเอง'];
                        return [...new Set([...defaults, ...existing])].sort();
                    });
                    const uniqueWards = computed(() => [...new Set(patients.value.map(p => p.admitWard).filter(x=>x))].sort());

                    const generateMockData = () => {
                        const arr = [];
                        const wards = ['ICU Med', 'Male Med', 'Female Med', 'Ward 10'];
                        for(let i=0; i<50; i++) {
                            const isIpd = Math.random() > 0.7;
                            arr.push({
                                id: 'P'+i, hn: 'HN'+(66000+i), an: isIpd?'AN'+i:undefined, firstName: 'User', lastName: i,
                                age: 40+Math.floor(Math.random()*40), gender: Math.random()>0.5?'ชาย':'หญิง',
                                status: isIpd?'IPD':'OPD', lvef: 15+Math.floor(Math.random()*50),
                                insurance: 'บัตรทอง (UC)',
                                address: { district: ['เมือง', 'ป่าซาง', 'ลี้'][Math.floor(Math.random()*3)], subDistrict: 'ในเมือง', province: 'ลำพูน', number: '1' },
                                admitWard: isIpd ? wards[Math.floor(Math.random()*wards.length)] : '',
                                isRespiFailure: isIpd ? Math.random()>0.8 : false,
                                isDiureticAdjust: isIpd ? Math.random()>0.5 : false,
                                admissionNote: 'รายละเอียดการรักษา...',
                                meds: { acei_arb: Math.random()>0.5, betaBlocker: Math.random()>0.5, mra: Math.random()>0.5, sglt2i: Math.random()>0.5, arni: false },
                                targetDoseReached: { acei_arb_arni: false, betaBlocker: false, mra: false },
                                lastAdmission: new Date().toISOString().split('T')[0],
                                nextAppointment: { date: new Date().toISOString().split('T')[0], location: 'OPD Cardio LPN (พุธ)' },
                                admissionCount: 1, phone: '081-123-4567', history: []
                            });
                        }
                        patients.value = arr;
                    };

                    return {
                        patients, isLoading, isGasEnvironment, userRole, isLoggedIn, activeTab, showModal, isSaving,
                        loginForm, formState, filter, locationLevel, locationBreadcrumb,
                        trackingStatusFilter, medViewMode,
                        currentPage, itemsPerPage, viewDate,
                        stats, ipdStats, opdStats, filteredPatients, paginatedPatients, totalPages, paginationEnd,
                        calendarDays,
                        uniqueProvinces, uniqueDistricts, uniqueSubDistricts, uniqueInsurances, uniqueWards,
                        fileInput, csvInput, pdfInput, uploadingFile,
                        login, logout, setFilter, clearFilter, resetLocationFilter, filterTotal,
                        openPatientModal, openEdit, closeModal, savePatient, confirmDelete, checkExistingHn,
                        changeMonth, selectCalendarDate, formatDate,
                        downloadCsv, backupDb, triggerImport, onFileSelected, printModal,
                        confirmDischarge,
                        triggerCsvImport, onCsvSelected, handleFileUpload
                    };
                }
            }).mount('#app');
        </script>
</body>
</html>